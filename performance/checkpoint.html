<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Automated SCA Performance Checkpoint runner</title>
</head>

<body>
    <h1>Automated SCA Performance Checkpoint runner</h1>

    <label for="domain">Domain</label>
    <input type="text" id="domain">
    <br><br>
    
    <h4>Starting test</h4>
    <textarea name="output1" id="output1" cols="120" rows="20" disabled></textarea>
    <br>

    <h4>Checking status</h4>
    <textarea name="output2" id="output2" cols="120" rows="20" disabled></textarea>
    <br>

    <h4>Test complete</h4>
    <textarea name="output3" id="output3" cols="120" rows="20" disabled></textarea>
    <br>

    <button id="run">Run</button>

    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    
    <!-- Utility methods-->
    <script>
        const ACTIONS = {
            RUNTEST: "runtest"
        }

        // Generates urls for the WPT API, depending on the required action
        const wptUrlGenerator = (domain, action) => {
            const API_KEY = "A.1a07cbeb958333564222919ef578c45e";
            const RUNS = 1;
            if (action.toLowerCase() === ACTIONS.RUNTEST) {
                return `http://www.webpagetest.org/runtest.php?url=${domain}&runs=${RUNS}&k=${API_KEY}&f=json`;
            }
            
        }

        // Returns a promise that is resolved once the polling is complete.
        // We know that the polling is complete when the "check" function returns true.
        const pollPromise = (fn, check, checkResult = false) => { 
            if (checkResult) return checkResult;
            const promise = fn();
            return promise.then(data => pollPromise(fn, check, check(data)));
        }
    </script>
   
    <!-- Event handlers -->
    <script>
        const executeAllTestSteps = () => {
            runTest()
            .then(waitCompleteStatus)
            .then(showResults);
        }

        const runTest = () => {
            let domain = $("#domain").val();
            const url = wptUrlGenerator(domain, ACTIONS.RUNTEST);
            return $.getJSON(url)
                    .then((response) => {
                        let data = response.data;
                        $("#output1").text(JSON.stringify(data, null,'  '));
                        return data;
                    });
        }

        const waitCompleteStatus = (data) => {
            // This method sends a request to get the current status of a test
            const getTestStatus = () => $.getJSON(data.jsonUrl);
            // This method checks if a test is ready
            const isTestReady = (data) => {
                if (data.statusCode !== 200) {
                    $("#output2").text(JSON.stringify(data, null,'  '));
                    return false;
                } else {
                    $("#output3").text(JSON.stringify(data, null,'  '));
                    return data;
                }
            }
            // Return a promise that polls until test results are ready.
            // When the results are ready, the promise fulfills
            return pollPromise(getTestStatus, isTestReady);
        }

        const showResults = (data) => {
            alert("the results are ready!", data);
        }
    </script>

    <!-- Events -->
    <script>
        $("#run").click(executeAllTestSteps);
    </script>
</body>

</html>